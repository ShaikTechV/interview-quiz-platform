<!DOCTYPE html>
<html>
<head>
    <title>Quiz - {{ access_code }}</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; }
        .timer { position: fixed; top: 20px; right: 20px; background: #dc3545; color: white; padding: 15px 20px; border-radius: 8px; font-weight: bold; z-index: 1000; }
        .timer.warning { background: #fd7e14; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0.7; } }
        .question { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #f8f9fa; }
        .question-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #333; }
        .options { margin: 15px 0; }
        .option { margin: 10px 0; padding: 12px; border: 2px solid #ddd; border-radius: 5px; cursor: pointer; transition: all 0.3s; }
        .option:hover { border-color: #007bff; background: #f0f8ff; }
        .option.selected { border-color: #007bff; background: #007bff; color: white; }
        .submit-btn { background: #28a745; color: white; padding: 15px 30px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; margin-top: 30px; }
        .submit-btn:hover { background: #218838; }
        .submit-btn:disabled { background: #6c757d; cursor: not-allowed; }
        .text-input { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px; margin: 10px 0; }
        .success-banner { background: #d4edda; color: #155724; padding: 15px; margin: 20px 0; border-radius: 5px; border: 1px solid #c3e6cb; text-align: center; font-weight: bold; }
        .completion-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; }
        .completion-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 40px; border-radius: 10px; text-align: center; max-width: 500px; }
        .progress-info { background: #f8f9fa; padding: 15px; margin: 20px 0; border-radius: 5px; border-left: 4px solid #007bff; }
    </style>
</head>
<body>
    <div class="timer" id="timer">45:00</div>
    
    <div class="container">
        <div class="success-banner">
            ‚úÖ SUCCESS: Quiz Interface Loaded Correctly!<br>
            Access Code: {{ access_code }} | Questions: {{ questions|length }}
        </div>
        
        <h1>Accounting & Finance Assessment</h1>
        <p>Professional interview evaluation - 45 minutes</p>
        
        <div class="progress-info">
            <strong>Progress:</strong> <span id="answered-count">0</span> of {{ questions|length }} questions answered
            <br><strong>Time Remaining:</strong> <span id="time-display">45:00</span>
        </div>

        <div id="questions">
            {% if questions %}
                {% for question in questions %}
                <div class="question" id="question-{{ question.id }}">
                    <div class="question-title">Question {{ loop.index }}: {{ question.question }}</div>
                    
                    {% if question.type == 'text_input' %}
                        <!-- Text Input Question -->
                        <input type="text" class="text-input" placeholder="Enter your answer here..." 
                               onchange="selectTextAnswer({{ question.id }}, this.value)"
                               id="text-{{ question.id }}">
                    {% else %}
                        <!-- Multiple Choice Question -->
                        <div class="options">
                            {% for option in question.options %}
                                {% if option != "N/A" %}
                                <div class="option" onclick="selectOption({{ question.id }}, {{ loop.index0 }})" 
                                     id="option-{{ question.id }}-{{ loop.index0 }}">
                                    {{ option }}
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <div class="question">
                    <p>No questions available. Please contact administrator.</p>
                </div>
            {% endif %}
        </div>

        <button class="submit-btn" onclick="submitQuiz()" id="submit-btn">Submit Quiz</button>
    </div>

    <!-- Completion Modal -->
    <div class="completion-modal" id="completion-modal">
        <div class="completion-content">
            <h2>üéâ Quiz Completed!</h2>
            <p id="completion-message">Processing your results...</p>
            <div id="completion-details"></div>
            <button onclick="goHome()" style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-top: 20px; cursor: pointer;">
                Return to Home
            </button>
        </div>
    </div>

    <script>
        const accessCode = '{{ access_code }}';
        const answers = {};
        const totalQuestions = {{ questions|length }};
        let timeLeft = 2700; // 45 minutes
        let isSubmitting = false;

        console.log('‚úÖ Quiz interface loaded successfully');
        console.log('Access Code:', accessCode);
        console.log('Total Questions:', totalQuestions);

        function updateTimer() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const display = minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
            
            const timerElement = document.getElementById('timer');
            const timeDisplayElement = document.getElementById('time-display');
            
            if (timerElement) {
                timerElement.textContent = 'Time: ' + display;
                
                if (timeLeft <= 300) { // Last 5 minutes
                    timerElement.classList.add('warning');
                }
                
                if (timeLeft <= 0) {
                    alert('Time is up! Quiz will be submitted automatically.');
                    submitQuiz();
                    return;
                }
            }
            
            if (timeDisplayElement) {
                timeDisplayElement.textContent = display;
            }
            
            timeLeft--;
        }

        function updateProgress() {
            const answeredCount = Object.keys(answers).length;
            const progressElement = document.getElementById('answered-count');
            if (progressElement) {
                progressElement.textContent = answeredCount;
            }
            
            console.log(`Progress: ${answeredCount}/${totalQuestions} questions answered`);
        }

        function selectOption(questionId, optionIndex) {
            if (isSubmitting) return;
            
            console.log('Selected option:', questionId, optionIndex);
            
            // Clear previous selections for this question
            const options = document.querySelectorAll('[id^="option-' + questionId + '-"]');
            options.forEach(opt => opt.classList.remove('selected'));
            
            // Select new option
            const selectedOption = document.getElementById('option-' + questionId + '-' + optionIndex);
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }
            
            // Save answer locally
            answers[questionId] = optionIndex;
            updateProgress();
            
            // Send to server immediately
            saveAnswerToServer(questionId, optionIndex);
        }

        function selectTextAnswer(questionId, value) {
            if (isSubmitting) return;
            
            console.log('Text answer:', questionId, value);
            
            // Save answer locally
            answers[questionId] = value;
            updateProgress();
            
            // Send to server immediately
            saveAnswerToServer(questionId, value);
        }

        function saveAnswerToServer(questionId, answer) {
            fetch('/submit_answer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    access_code: accessCode,
                    question_id: questionId,
                    answer: answer
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('‚úÖ Answer saved successfully:', questionId, answer);
                } else {
                    console.error('‚ùå Failed to save answer:', data.error);
                }
            })
            .catch(error => {
                console.error('‚ùå Error saving answer:', error);
            });
        }

        function submitQuiz() {
            if (isSubmitting) {
                console.log('Quiz already being submitted...');
                return;
            }
            
            // Confirm submission
            const answeredCount = Object.keys(answers).length;
            if (answeredCount < totalQuestions) {
                const unanswered = totalQuestions - answeredCount;
                if (!confirm(`You have ${unanswered} unanswered questions. Are you sure you want to submit?`)) {
                    return;
                }
            }
            
            isSubmitting = true;
            const submitBtn = document.getElementById('submit-btn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Submitting...';
            }
            
            console.log('üîÑ Submitting quiz...');
            console.log('Final answers:', answers);
            
            fetch('/submit_quiz', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ access_code: accessCode })
            })
            .then(response => response.json())
            .then(data => {
                console.log('üì§ Quiz submission response:', data);
                
                if (data.success) {
                    showCompletionModal(data);
                } else {
                    alert('Error submitting quiz: ' + (data.error || 'Unknown error'));
                    isSubmitting = false;
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit Quiz';
                    }
                }
            })
            .catch(error => {
                console.error('‚ùå Error submitting quiz:', error);
                alert('Network error submitting quiz. Please try again.');
                isSubmitting = false;
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Quiz';
                }
            });
        }

        function showCompletionModal(results) {
            const modal = document.getElementById('completion-modal');
            const message = document.getElementById('completion-message');
            const details = document.getElementById('completion-details');
            
            if (modal && message && details) {
                message.textContent = 'Thank you for completing the assessment!';
                
                const percentage = results.percentage || 0;
                let gradeColor = '#dc3545'; // Red for low scores
                if (percentage >= 70) gradeColor = '#28a745'; // Green for high scores
                else if (percentage >= 50) gradeColor = '#ffc107'; // Yellow for medium scores
                
                details.innerHTML = `
                    <div style="margin: 20px 0; padding: 20px; border-radius: 8px; background: #f8f9fa;">
                        <h3>Your Results:</h3>
                        <p><strong>Score:</strong> ${results.score}/${results.total}</p>
                        <p><strong>Percentage:</strong> <span style="color: ${gradeColor}; font-weight: bold; font-size: 24px;">${percentage}%</span></p>
                        <p><strong>Questions Answered:</strong> ${Object.keys(answers).length}/${totalQuestions}</p>
                        <hr>
                        <p><em>Your results have been saved. Please contact your administrator for detailed feedback.</em></p>
                    </div>
                `;
                
                modal.style.display = 'block';
                
                // Auto-hide after 30 seconds
                setTimeout(() => {
                    goHome();
                }, 30000);
            }
        }

        function goHome() {
            window.location.href = '/';
        }

        // Start timer
        const timerInterval = setInterval(updateTimer, 1000);
        updateTimer(); // Initialize immediately
        
        // Prevent page refresh
        window.addEventListener('beforeunload', function(e) {
            if (Object.keys(answers).length > 0 && !isSubmitting) {
                e.preventDefault();
                e.returnValue = 'Are you sure you want to leave? Your progress will be lost.';
            }
        });

        // Auto-save answers periodically
        setInterval(() => {
            if (!isSubmitting && Object.keys(answers).length > 0) {
                console.log('üîÑ Auto-saving progress...');
                // Answers are already saved individually, this is just a log
            }
        }, 30000); // Every 30 seconds

        console.log('‚úÖ Quiz ready! You can start answering questions.');
    </script>
</body>
</html>
