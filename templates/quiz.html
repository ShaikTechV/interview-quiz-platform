<!DOCTYPE html>
<html>
<head>
    <title>{{ quiz_data.title }}</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; }
        .timer { position: fixed; top: 20px; right: 20px; background: #dc3545; color: white; padding: 15px 20px; border-radius: 8px; font-weight: bold; z-index: 1000; }
        .timer.warning { background: #fd7e14; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0.7; } }
        .question { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #f8f9fa; }
        .question-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #333; }
        .options { margin: 15px 0; }
        .option { margin: 10px 0; padding: 12px; border: 2px solid #ddd; border-radius: 5px; cursor: pointer; transition: all 0.3s; }
        .option:hover { border-color: #007bff; background: #f0f8ff; }
        .option.selected { border-color: #007bff; background: #007bff; color: white; }
        .submit-btn { background: #28a745; color: white; padding: 15px 30px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; margin-top: 30px; }
        .submit-btn:hover { background: #218838; }
    </style>
</head>
<body>
    <div class="timer" id="timer">45:00</div>
    
    <div class="container">
        <h1>{{ quiz_data.title }}</h1>
        <p>{{ quiz_data.description }}</p>
        <p><strong>Access Code:</strong> {{ access_code }} | <strong>Questions:</strong> {{ questions|length }}</p>

        <div id="questions">
            {% for question in questions %}
            <div class="question">
                <div class="question-title">Q{{ loop.index }}: {{ question.question }}</div>
                <div class="options">
                    {% for option in question.options %}
                    {% if option != "N/A" %}
                    <div class="option" onclick="selectOption({{ question.id }}, {{ loop.index0 }})" 
                         id="option-{{ question.id }}-{{ loop.index0 }}">
                        {{ option }}
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>

        <button class="submit-btn" onclick="submitQuiz()">Submit Quiz</button>
    </div>

    <script>
        const accessCode = '{{ access_code }}';
        const answers = {};
        let timeLeft = {{ quiz_data.time_limit }};

        function updateTimer() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const display = minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
            
            const timerElement = document.getElementById('timer');
            timerElement.textContent = 'Time: ' + display;
            
            if (timeLeft <= 300) { // Last 5 minutes
                timerElement.classList.add('warning');
            }
            
            if (timeLeft <= 0) {
                alert('Time is up! Quiz will be submitted automatically.');
                submitQuiz();
                return;
            }
            
            timeLeft--;
        }

        function selectOption(questionId, optionIndex) {
            // Clear previous selections for this question
            const options = document.querySelectorAll(`[id^="option-${questionId}-"]`);
            options.forEach(opt => opt.classList.remove('selected'));
            
            // Select new option
            document.getElementById(`option-${questionId}-${optionIndex}`).classList.add('selected');
            
            // Save answer
            answers[questionId] = optionIndex;
            
            // Send to server
            fetch('/submit_answer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    access_code: accessCode,
                    question_id: questionId,
                    answer: optionIndex
                })
            });
        }

        function submitQuiz() {
            fetch('/submit_quiz', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ access_code: accessCode })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Quiz completed! Your score: ${data.score}/${data.total} (${data.percentage}%)`);
                    window.location.href = '/';
                }
            });
        }

        // Start timer
        setInterval(updateTimer, 1000);
        
        // Prevent page refresh
        window.addEventListener('beforeunload', function(e) {
            e.preventDefault();
            e.returnValue = '';
        });
    </script>
</body>
</html>
